include:
  - ../../test/dummy-sshd.yaml

services:

  e2eweb:
    build:
      context: ../..
      dockerfile: Dockerfile.e2eweb
    environment:
      - SSHPIPERD_E2EWEB_BASEURL=http://e2eweb:3000
    ports:
      - "2222:2222"
      - "3000:3000"
    depends_on:
      - host-password
      - host-publickey
    volumes:
      - shared:/shared

  testrunner:
    build:
      context: ../..
      dockerfile_inline: |
        FROM docker.io/golang:1.25-bookworm
        RUN apt-get update && apt-get install -y --no-install-recommends openssh-client curl netcat-openbsd && rm -rf /var/lib/apt/lists/*
        RUN mkdir -p /src
        WORKDIR /src
    depends_on:
      - e2eweb
    volumes:
      - ../..:/src
      - shared:/shared
    command:
      - /bin/bash
      - -c
      - |
        set -euo pipefail
        # wait for e2eweb to be ready
        until nc -z e2eweb 2222; do sleep 1; done
        session_file=/tmp/ssh.out
        ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -p 2222 test@e2eweb "echo ok" >"$session_file" 2>&1 &
        ssh_pid=$!
        for _ in $(seq 1 30); do
          session=$(sed -n 's/.*\/pipe\/\([A-Za-z0-9-]*\).*/\1/p' "$session_file" | head -n1)
          [ -n "$session" ] && break
          sleep 1
        done
        if [ -z "$session" ]; then
          echo "failed to extract session id from ssh output"
          cat "$session_file"
          exit 1
        fi
        curl -sSf -X POST -H "X-SSHPIPER-SESSION: $session" -H "X-SSHPIPER-UPSTREAM: user:pass@host-password:2222" http://e2eweb:3000/approve
        wait $ssh_pid || true
        timeout 20s ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -p 2222 test@e2eweb "echo ok" >"$session_file" 2>&1
        grep -q "ok" "$session_file"

volumes:
  shared:
    driver_opts:
      type: tmpfs
      device: tmpfs
  sshconfig_publickey:
  sshconfig_password:
